---
title: "Tidy data and the Tidyverse"
description: |
  Introduction to tidy data and how to convert between wide and long data with the tidyr R package.
author:
  - name: Stephanie Hicks
    url: https://stephaniehicks.com/
    affiliation: Department of Biostatistics, Johns Hopkins
    affiliation_url: https://www.jhsph.edu
date: 09-07-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 3
categories:
  - module 1
  - week 2
  - R
  - Programming
  - tidyr
  - here
  - tidyverse
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

> "Happy families are all alike; every unhappy family is unhappy in 
> its own way." –– Leo Tolstoy

> "Tidy datasets are all alike, but every messy dataset is messy in 
> its own way." –– Hadley Wickham



# Pre-lecture materials

### Read ahead

:::resources

**Before class, you can prepare by reading the following materials:**

1. [Tidy Data](https://www.jstatsoft.org/article/view/v059i10) paper published in the Journal of Statistical Software
2. https://r4ds.had.co.nz/tidy-data.html 
3. [tidyr cheat sheet from RStudio](http://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

:::


### Acknowledgements

Material for this lecture was borrowed and adopted from

- https://rdpeng.github.io/Biostat776/lecture-tidy-data-and-the-tidyverse.html
- https://r4ds.had.co.nz/tidy-data.html 

# Learning objectives

:::keyideas

**At the end of this lesson you will:**

- Define tidy data 
- Be able to transform non-tidy data into tidy data
- Be able to transform wide data into long data
- Be able to separate character columns into multiple columns
- Be able to unite multiple character columns into one column

:::


# Tidy data

As we learned in the last lesson, one unifying concept of the tidyverse is the notion of **tidy data**. As defined by Hadley Wickham in his 2014 paper published in the *Journal of Statistical Software*, a [tidy dataset](https://www.jstatsoft.org/article/view/v059i10) has the following properties:

1. Each variable forms a column.

2. Each observation forms a row.

3. Each type of observational unit forms a table.


```{r tidy-data, echo = FALSE, fig.cap = "Artwork by Allison Horst on tidy data", out.width = '60%', fig.align='center', preview = TRUE}
knitr::include_graphics("https://github.com/allisonhorst/stats-illustrations/raw/master/rstats-artwork/tidydata_1.jpg")
```

[**Source**: [Artwork by Allison Horst](https://github.com/allisonhorst/stats-illustrations)]


The purpose of defining tidy data is to highlight the fact that *most data do not start out life as tidy*. In fact, much of the work of data analysis may involve simply making the data tidy (at least this has been our experience). Once a dataset is tidy, it can be used as input into a variety of other functions that may transform, model, or visualize the data.

As a quick example, consider the following data illustrating death rates in Virginia in 1940 in a classic table format:

```{r}
library(datasets)
VADeaths
```

While this format is canonical and is useful for quickly observing the relationship between multiple variables, it is not tidy. This format violates the tidy form because there are variables in both the rows and columns. In this case the variables are age category, gender, and urban-ness. Finally, the death rate itself, which is the fourth variable, is presented inside the table. 

Converting this data to tidy format would give us

```{r, message=FALSE}
library(tidyverse)

VADeaths %>%
  as_tibble() %>%
  mutate(age = row.names(VADeaths)) %>%
  pivot_longer(-age) %>%
  separate(name, c("urban", "gender"), sep = " ") %>%
  mutate(age = factor(age), urban = factor(urban), gender = factor(gender))
```

Some of these functions you have seen before, others might be new to you. Let's talk about each one in the context of the Tidyverse package. 


# The "Tidyverse"

There are a number of R packages that take advantage of the tidy data form and can be used to do interesting things with data. Many (but not all) of these packages are written by Hadley Wickham and the collection of packages is sometimes referred to as the "tidyverse" because of their dependence on and presumption of tidy data. "Tidyverse" packages include:

* [ggplot2](https://cran.r-project.org/package=ggplot2): a plotting system based on the grammar of graphics

* [magrittr](https://cran.r-project.org/package=magrittr"): defines the `%>%` operator for chaining functions together in a series of operations on data

* [dplyr](https://cran.r-project.org/package=dplyr): a suite of (fast) functions for working with data frames

* [tidyr](https://cran.r-project.org/package=tidyr): easily tidy data with `pivot_wider()` and `pivot_longer()` functions (also `separate()` and `unite()`)

We will be using these packages quite a bit this week.

The "tidyverse" package can be used to install all of the packages in the tidyverse at once. For example, instead of starting an R script with this: 

```{r, eval = FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
```

You can start with this: 

```{r, eval = FALSE}
library(tidyverse)
```

Ok, so the first three lines, you should recognize what is happening: 

```{r, message=FALSE}
VADeaths %>%
  as_tibble() %>%
  mutate(age = row.names(VADeaths))
```

We did the following: 

1. Converted the VADeaths `data.frame` to a tibble. 
2. Added a new column called `age` which contained the row name information so all information is contained in a given column. 

Let's talk about the `pivot_longer()`  and `pivot_wider()` functions next. 

### `pivot_longer()` and `pivot_wider()`

The `tidyr` package includes functions to transfer a data frame between *long* and *wide*. 

- **Wide format** data tends to have different attributes or variables describing an observation placed in separate columns. 
- **Long format** data tends to have different attributes encoded as levels of a single variable, followed by another column that contains tha values of the observation at those different levels. 

In the section above, we showed an example that used `pivot_longer()` to convert data into a tidy format. 

After changing the age categories from row names to a variable (which can be done with the `mutate` function), the key problem with the tidyness of the data is that the variables of urban / rural and male / female are not in their own columns, but rather are embedded in the structure of the columns. 

To fix this, you can use the `pivot_longer()` function to gather values spread across several columns into a single column, with the column names gathered into a "name" column. When gathering, exclude any columns that you do not want "gathered" (`age` in this case) by including the column names with a the minus sign in the `pivot_longer()` function. For example:

```{r}
# Gather everything EXCEPT age to tidy data
VADeaths %>%
  as_tibble() %>%
  mutate(age = row.names(VADeaths)) %>%
  pivot_longer(-age)
```

Even if your data is in a tidy format, `pivot_longer()` is occasionally useful for pulling data together to take advantage of faceting, or plotting separate plots based on a grouping variable. We will talk more about that in a future lecture. 

The `pivot_wider()` function is less commonly needed to tidy data. It can, however, be useful for creating summary tables. For example, you use the `summarize()` function in `dplyr` to summarize the mean death rates by age across both rural / urban and male / female 

```{r}
VADeaths %>%
  as_tibble() %>%
  mutate(age = row.names(VADeaths)) %>%
  pivot_longer(-age) %>% 
  group_by(age) %>% 
  summarize(mean_value = mean(value)) %>% 
  pivot_wider(names_from = "age", 
              values_from = "mean_value") %>%
  knitr::kable()
```

Notice in this example how `pivot_wider()` has been used at the very end of the code sequence to convert the summarized data into a shape that offers a better tabular presentation for a report. In the `pivot_wider()` call, you first specify the name of the column to use for the new column names (`age` in this example) and then specify the column to use for the cell values (`mean_value` here).


### `separate()` and `unite()`

The same `tidyr` package also contains two useful functions: 

- `unite()`: combine contents of two or more columns into a single column
- `separate()`:  separate contents of a column into two or more columns

If you recall, this is where we were at: 

```{r}
VADeaths %>%
  as_tibble() %>%
  mutate(age = row.names(VADeaths)) %>%
  pivot_longer(-age)
```

Next, we want to take the `name` column and separate the two types of information into two columns using the `col`, `into` and `sep` arguments: 

```{r}
VADeaths %>%
  as_tibble() %>%
  mutate(age = row.names(VADeaths)) %>%
  pivot_longer(-age) %>%
  separate(col=name, into=c("urban", "gender"), sep = " ")
```


The last step we want to do is convert the data types of the first three columns from characters to factors: 

```{r}
VADeaths %>%
  as_tibble() %>%
  mutate(age = row.names(VADeaths)) %>%
  pivot_longer(-age) %>%
  separate(col=name, into=c("urban", "gender"), sep = " ") %>%
  mutate(age = factor(age), urban = factor(urban), gender = factor(gender))
```


# Post-lecture materials

### Final Questions 

Here are some post-lecture questions to help you think about the material discussed.

:::questions

**Questions:**

1. Using prose, describe how the variables and observations are organised in a tidy dataset versus an non-tidy dataset.

2. What do the extra and fill arguments do in `separate()`? Experiment with the various options for the following two toy datasets.

```{r, eval=FALSE}
tibble(x = c("a,b,c", "d,e,f,g", "h,i,j")) %>% 
  separate(x, c("one", "two", "three"))

tibble(x = c("a,b,c", "d,e", "f,g,i")) %>% 
  separate(x, c("one", "two", "three"))
```

3. Both `unite()` and `separate()` have a remove argument. What does it do? Why would you set it to FALSE?

4. Compare and contrast `separate()` and `extract()`. Why are there three variations of separation (by position, by separator, and with groups), but only one `unite()`?

:::


### Additional Resources 

:::resources 

- [Tidy Data](https://www.jstatsoft.org/article/view/v059i10) paper published in the Journal of Statistical Software
- https://r4ds.had.co.nz/tidy-data.html 
- [tidyr cheat sheet from RStudio](http://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)


::: 
